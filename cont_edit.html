<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Düzenlenebilir Kart (Yerel Resim Yükleme)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6">

          <!-- KART -->
          <div class="card shadow-sm mb-4" style="justify-self: center; width: 17rem; height: 24rem;">
            <div style="width: 100%; height:auto; display: flex; justify-content: center;">
              <img id="cardImage" src="images/no_image.jpg" class="card-img-top" style="width:max-content; height: 12rem;" alt="Kart Görseli">
            </div>
            <div class="card-body">
              <h5 id="cardTitle" class="card-title">Kart Başlığı</h5>
              <p id="cardText" class="card-text">Bu, kart açıklamasıdır. Burada kartla ilgili kısa bir bilgi yer alır.</p>
            </div>
          </div>

          <!-- DÜZENLEME FORMU -->
          <div class="card p-3 shadow-sm">
            <h5 class="mb-3">Kartı Düzenle</h5>
            <form id="editForm">
              <div class="mb-3">
                <label for="imageFile" class="form-label">Yeni Resim Yükle</label>
                <input type="file" class="form-control" id="imageFile" accept="image/*">
              </div>

              <div class="mb-3">
                <label for="titleInput" class="form-label">Başlık</label>
                <input type="text" class="form-control" id="titleInput" placeholder="Yeni başlık girin...">
              </div>

              <div class="mb-3">
                <label for="textInput" class="form-label">Açıklama</label>
                <textarea class="form-control" id="textInput" rows="3" placeholder="Yeni açıklama girin..."></textarea>
              </div>

              <div style="display:flex;">
                <button type="button" class="btn btn-primary w-50" id="updateBtn">Güncelle</button>
                <button type="button" class="btn btn-success w-50" id="saveBtn">Kaydet</button>

                <!-- Toast -->
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                  <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                      <img src="images/profiles/sup_profile.png" style="width: 10%; height: 10%;" class="rounded me-2" alt="...">
                      <strong class="me-auto">Oğuzhan</strong>
                      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div id="texttoast" class="toast-body"></div>
                  </div>
                </div>
              </div>

            </form>
          </div>

        </div>
      </div>
    </div>

    <script>
      const updateBtn = document.getElementById('updateBtn');
      const saveBtn = document.getElementById("saveBtn");

      // Önizleme ve DOM güncelleme
      updateBtn.addEventListener('click', () => {
        const title = document.getElementById('titleInput').value;
        const text = document.getElementById('textInput').value;
        const fileInput = document.getElementById('imageFile');
        const imageElement = document.getElementById('cardImage');

        if (title) document.getElementById('cardTitle').textContent = title;
        if (text) document.getElementById('cardText').textContent = text;

        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => { imageElement.src = e.target.result; };
          reader.readAsDataURL(fileInput.files[0]);
        }
      });

      // Kaydetme (DB ve GitHub)
      saveBtn.addEventListener('click', async () => {
        const title = document.getElementById('titleInput').value;
        const text = document.getElementById('textInput').value;
        const fileInput = document.getElementById('imageFile');
        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get("id"));
        const file = fileInput.files[0];
        const branch = 'main';

        // 1️⃣ Postgres DB Güncelle
        try {
          await fetch("/.netlify/functions/updateCards", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id,
              photo_url: file ? `images/cards/galery_${id}.${file.name.split('.').pop()}` : document.getElementById('cardImage').src,
              title,
              example: text
            })
          });
        } catch (err) {
          showToast("Kart güncellenemedi: " + err.message);
          return;
        }

        // 2️⃣ Dosya seçilmediyse GitHub yüklemeyi atla
        if (!file) {
          showToast("✅ Kart güncellendi (resim değişmedi).");
          window.location.href = "dashboard.html";
          return;
        }

        // 3️⃣ GitHub yükleme
        const extension = file.name.split('.').pop();
        const fileName = `galery_${id}.${extension}`;

        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          try {
            const res = await fetch('/.netlify/functions/uploadToGitHub', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ filename: fileName, content: base64, branch })
            });
            const data = await res.json();
            if (res.ok) showToast("✅ Kart ve resim güncellendi!"),window.location.href = "dashboard.html";
            else showToast(`❌ Hata oluştu: ${JSON.stringify(data)}`);
          } catch (err) { showToast(`❌ Hata: ${err.message}`); }
        };
        reader.readAsDataURL(file);
      });

      // Toast helper
      function showToast(message) {
        const toastLiveExample = document.getElementById('liveToast');
        const toasttext = document.getElementById("texttoast");
        toasttext.innerText = message;
        const toast = new bootstrap.Toast(toastLiveExample);
        toast.show();
      }

      // Sayfa yüklendiğinde DB'den veriyi çek
      async function loadLink() {
        try {
          const response = await fetch('/.netlify/functions/getCards');
          if (!response.ok) throw new Error('Veri çekilemedi');

          const cards = await response.json();
          const params = new URLSearchParams(window.location.search);
          const ids = parseInt(params.get("id"));
          const card = cards.find(card => card.id === ids);
          if (!card) return;

          document.getElementById('cardImage').src = card.photo_url;
          document.getElementById('cardTitle').textContent = card.title;
          document.getElementById('cardText').textContent = card.example;

        } catch (error) { console.error('Error fetching data:', error); }
      }

      loadLink();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
